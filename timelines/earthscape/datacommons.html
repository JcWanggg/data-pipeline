<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Timeline from Data Commons</title>
<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link type="text/css" href="../../../localsite/css/base.css" rel="stylesheet" id="/localsite/css/base.css" />
<script type="text/javascript" src="../../../localsite/js/localsite.js?showheader=true&showsearch=true"></script>
</head>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    async function fetchCountyGeoIds() {
        // Fetch all geoIds containing geoId/06 in name + are counties
        const response = await fetch('https://api.datacommons.org/v2/observation?key=AIzaSyCTI4Xz-UW_G2Q2RfknhcfdAnTHq5X5XuI&entity.expression=geoId%2F06%3C-containedInPlace%2B%7BtypeOf%3ACounty%7D&select=date&select=entity&select=value&select=variable&variable.dcids=LandCoverFraction_Forest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "dates": ""
            })
        });
        const data = await response.json();

        // Use the geoId list to fetch respective county + state names
        const geoIds = Object.keys(data.byVariable.LandCoverFraction_Forest.byEntity);
        const response2 = await fetch('https://api.datacommons.org/v2/node?key=AIzaSyCTI4Xz-UW_G2Q2RfknhcfdAnTHq5X5XuI', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "nodes": geoIds,
                "property": "->[containedInPlace, name]"
            })
        });
        const data2 = await response2.json();

        // Put data together
        const countyData = {};
        Object.keys(data2.data).forEach(geoId => {
            node = data2.data[geoId].arcs;
            stateName = node.containedInPlace.nodes[0]['name'];
            countyName = node.name.nodes[0]['value'];
            countyData[geoId] = {
                name: countyName,
                state: stateName
            };
        })
        return countyData;
    }

    async function fetchForestCoverage(geoIds) {
        // Fetch forest coverage data using geoIds list
        // TODO - Figure out how to put variable.dcids and entity.dcids in the body section instead of URL
        const url = `https://api.datacommons.org/v2/observation?key=AIzaSyCTI4Xz-UW_G2Q2RfknhcfdAnTHq5X5XuI&variable.dcids=LandCoverFraction_Forest&${geoIds.map(id => `entity.dcids=${id}`).join('&')}`
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "date": "",
                "select": ["date", "entity", "value", "variable"]
            })
        })
        const data = await response.json();
        return data;
    }

    async function getFormattedData() {
        const geoIdsData = await fetchCountyGeoIds();
        const geoIds = Object.keys(geoIdsData);
        const forestCoverageData = await fetchForestCoverage(geoIds);

        const formattedData = [];
        for (const geoId in geoIdsData) {
            formattedData.push({
                county: `${geoIdsData[geoId].name}, ${geoIdsData[geoId].state}`,
                observations: forestCoverageData.byVariable.LandCoverFraction_Forest.byEntity[geoId].orderedFacets[0]['observations']
            })
        }
        return formattedData;
    }

    async function getGraph(showAll) {
        const data = await getFormattedData();

        // Get unique years
        let yearsSet = new Set();
        data.forEach(county => {
            county.observations.forEach(obs => {
                yearsSet.add(obs.date);
            });
        });
        const years = [...yearsSet];
        
        // Logic for showing all counties or top 10 counties only
        let selectedData;
        console.log(showAll);
        if (showAll) {
            selectedData = data;
        } else {
            // Sort counties by average land cover and take top 10
            data.forEach(county => {
                county.averageLandCover = county.observations.reduce((sum, obs) => sum + obs.value, 0) / county.observations.length;
            });
            selectedData = data.sort((a, b) => b.averageLandCover - a.averageLandCover).slice(0, 5);
        }

        // Get datasets
        const datasets = selectedData.map(county => {
            return {
                label: county.county,
                data: years.map(year => {
                    const observation = county.observations.find(obs => obs.date === year);
                    return observation ? observation.value : null;
                }),
                borderColor: 'rgb(' + Math.floor(Math.random() * 256) + ', ' + Math.floor(Math.random() * 256) + ', ' + Math.floor(Math.random() * 256) + ')',
	            backgroundColor: 'rgba(0, 0, 0, 0)',
            };
        });

        const config = {
            type: 'line',
            data: {
                labels: years,
                datasets: datasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Forest Land Cover by County'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Year'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Forest Land Cover (%)'
                        }
                    }
                }
            }
        };

        // Delete chart if already exists (when we toggle checkbox)
        if (myChart instanceof Chart) {
            console.log(myChart);
            myChart.destroy();
        }
        const ctx = document.getElementById('myChart').getContext('2d');
        myChart = new Chart(ctx, config);
    }
    document.addEventListener('DOMContentLoaded', () => {
        getGraph();
        document.getElementById('showAllToggle').addEventListener('change', (event) => {
            showAll = event.target.checked;
            getGraph(showAll);
        });
    });
</script>

<body>
    <div class="content contentpadding">

        <a href="../">Timelines</a><br>
    
        <h2>California Forest Land Cover - Top 5 Counties</h2>
        <label>
            <input type="checkbox" id="showAllToggle">
            Show All
        </label>
        <canvas id="myChart"></canvas>
        <div id="earthscape1"></div>
        <br>
        
    
        <div id="readmeDiv"></div>
    </div>
    <!-- Needs work:
	<a href="https://chatgpt.com/share/e0e882e9-9a14-4677-abf5-399e509db10d">Source: ChatGPT</a><br><br>
	<a href="/feed/view/#feed=LandCoverFraction_Forest">Our working feed request</a> -->
</body>