<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Timeline from Data Commons</title>
<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link type="text/css" href="../../../localsite/css/base.css" rel="stylesheet" id="/localsite/css/base.css" />
<script type="text/javascript" src="../../../localsite/js/localsite.js?showheader=true&showsearch=true"></script>
</head>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    async function fetchCountyGeoIds(graphVariable, entityId) {
        // Fetch all geoIds containing geoId/06 in name + are counties
        const response = await fetch(`https://api.datacommons.org/v2/observation?key=AIzaSyCTI4Xz-UW_G2Q2RfknhcfdAnTHq5X5XuI&entity.expression=${entityId}%3C-containedInPlace%2B%7BtypeOf%3ACounty%7D&select=date&select=entity&select=value&select=variable&variable.dcids=${graphVariable}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "dates": ""
            })
        });
        const data = await response.json();

        // Use the geoId list to fetch respective county + state names
        const geoIds = Object.keys(data.byVariable[graphVariable].byEntity);
        const response2 = await fetch('https://api.datacommons.org/v2/node?key=AIzaSyCTI4Xz-UW_G2Q2RfknhcfdAnTHq5X5XuI', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "nodes": geoIds,
                "property": "->[containedInPlace, name]"
            })
        });
        const data2 = await response2.json();

        // Put data together
        const countyData = {};
        Object.keys(data2.data).forEach(geoId => {
            node = data2.data[geoId].arcs;
            stateName = node.containedInPlace.nodes[0]['name'];
            countyName = node.name.nodes[0]['value'];
            countyData[geoId] = {
                name: countyName,
                state: stateName
            };
        })
        return countyData;
    }

    async function fetchDataPoints(geoIds, graphVariable) {
        // Fetch forest coverage data using geoIds list
        // TODO - Figure out how to put variable.dcids and entity.dcids in the body section instead of URL
        const url = `https://api.datacommons.org/v2/observation?key=AIzaSyCTI4Xz-UW_G2Q2RfknhcfdAnTHq5X5XuI&variable.dcids=${graphVariable}&${geoIds.map(id => `entity.dcids=${id}`).join('&')}`
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "date": "",
                "select": ["date", "entity", "value", "variable"]
            })
        })
        const data = await response.json();
        return data;
    }

    async function getFormattedData(graphVariable, entityId) {
        const geoIdsData = await fetchCountyGeoIds(graphVariable, entityId);
        const geoIds = Object.keys(geoIdsData);
        const forestCoverageData = await fetchDataPoints(geoIds, graphVariable);

        const formattedData = [];
        for (const geoId in geoIdsData) {
            formattedData.push({
                county: `${geoIdsData[geoId].name}, ${geoIdsData[geoId].state}`,
                observations: forestCoverageData.byVariable[graphVariable].byEntity[geoId].orderedFacets[0]['observations']
            })
        }
        return formattedData;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const selectElement = document.getElementById('graphVariable');
        const h2Element = document.querySelector('h2');
        let graphVariable = 'LandCoverFraction_Forest';
        let showAll = false;
        let entityId = 'geoId/06'
        let myChart;

        // Function to update the H2 tag text and chart title
        const updateTexts = () => {
            const selectedOptionText = selectElement.options[selectElement.selectedIndex].text;
            h2Element.textContent = `${selectedOptionText} - Top 5 Counties`;
            if (myChart) {
                myChart.options.plugins.title.text = `${selectedOptionText} - Top 5 Counties`;
                myChart.update();
            }
        };

    // Function to fetch and display the graph
        async function getGraph(showAll, graphVariable, entityId) {
            const data = await getFormattedData(graphVariable, entityId);

            // Get unique years
            let yearsSet = new Set();
            data.forEach(county => {
                county.observations.forEach(obs => {
                    yearsSet.add(obs.date);
                });
            });
            const years = [...yearsSet];
            
            // Logic for showing all counties or top 5 counties only
            let selectedData;
            if (showAll) {
                selectedData = data;
            } else {
                // Sort counties by average land cover and take top 5
                data.forEach(county => {
                    county.averageLandCover = county.observations.reduce((sum, obs) => sum + obs.value, 0) / county.observations.length;
                });
                selectedData = data.sort((a, b) => b.averageLandCover - a.averageLandCover).slice(0, 5);
            }

            // Get datasets
            const datasets = selectedData.map(county => {
                return {
                    label: county.county,
                    data: years.map(year => {
                        const observation = county.observations.find(obs => obs.date === year);
                        return observation ? observation.value : null;
                    }),
                    borderColor: 'rgb(' + Math.floor(Math.random() * 256) + ', ' + Math.floor(Math.random() * 256) + ', ' + Math.floor(Math.random() * 256) + ')',
                    backgroundColor: 'rgba(0, 0, 0, 0)',
                };
            });

            const config = {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `${selectElement.options[selectElement.selectedIndex].text} - Top 5 Counties`
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: `${selectElement.options[selectElement.selectedIndex].text}`
                            }
                        }
                    }
                }
            };

            // Delete chart if it already exists
            if (myChart instanceof Chart) {
                myChart.destroy();
            }
            const ctx = document.getElementById('myChart').getContext('2d');
            myChart = new Chart(ctx, config);
        }

        updateTexts();
        getGraph(showAll, graphVariable, entityId);

        // Event listeners
        document.getElementById('showAllToggle').addEventListener('change', (event) => {
            showAll = event.target.checked;
            getGraph(showAll, graphVariable, entityId);
        });

        document.getElementById('graphVariable').addEventListener('change', (event) => {
            graphVariable = event.target.value;
            updateTexts();
            getGraph(showAll, graphVariable, entityId);
        });

        document.getElementById('entityId').addEventListener('change', (event) => {
            entityId = event.target.value;
            getGraph(showAll, graphVariable, entityId);
        });
    });

</script>

<body>
    <div class="content contentpadding">

        <a href="../">Timelines</a><br>
    
        <h2></h2>
        <br>
        <select id="entityId">
            <option value="geoId/01">Alabama</option>
            <option value="geoId/02">Alaska</option>
            <option value="geoId/04">Arizona</option>
            <option value="geoId/05">Arkansas</option>
            <option value="geoId/06" selected>California</option>
            <option value="geoId/08">Colorado</option>
            <option value="geoId/09">Connecticut</option>
            <option value="geoId/10">Delaware</option>
            <option value="geoId/11">District of Columbia</option>
            <option value="geoId/12">Florida</option>
            <option value="geoId/13">Georgia</option>
            <option value="geoId/15">Hawaii</option>
            <option value="geoId/16">Idaho</option>
            <option value="geoId/17">Illinois</option>
            <option value="geoId/18">Indiana</option>
            <option value="geoId/19">Iowa</option>
            <option value="geoId/20">Kansas</option>
            <option value="geoId/21">Kentucky</option>
            <option value="geoId/22">Louisiana</option>
            <option value="geoId/23">Maine</option>
            <option value="geoId/24">Maryland</option>
            <option value="geoId/25">Massachusetts</option>
            <option value="geoId/26">Michigan</option>
            <option value="geoId/27">Minnesota</option>
            <option value="geoId/28">Mississippi</option>
            <option value="geoId/29">Missouri</option>
            <option value="geoId/30">Montana</option>
            <option value="geoId/31">Nebraska</option>
            <option value="geoId/32">Nevada</option>
            <option value="geoId/33">New Hampshire</option>
            <option value="geoId/34">New Jersey</option>
            <option value="geoId/35">New Mexico</option>
            <option value="geoId/36">New York</option>
            <option value="geoId/37">North Carolina</option>
            <option value="geoId/38">North Dakota</option>
            <option value="geoId/39">Ohio</option>
            <option value="geoId/40">Oklahoma</option>
            <option value="geoId/41">Oregon</option>
            <option value="geoId/42">Pennsylvania</option>
            <option value="geoId/44">Rhode Island</option>
            <option value="geoId/45">South Carolina</option>
            <option value="geoId/46">South Dakota</option>
            <option value="geoId/47">Tennessee</option>
            <option value="geoId/48">Texas</option>
            <option value="geoId/49">Utah</option>
            <option value="geoId/50">Vermont</option>
            <option value="geoId/51">Virginia</option>
            <option value="geoId/53">Washington</option>
            <option value="geoId/54">West Virginia</option>
            <option value="geoId/55">Wisconsin</option>
            <option value="geoId/56">Wyoming</option>
            <option value="geoId/72">Puerto Rico</option>
        </select>
        <select id="graphVariable">
            <!-- <option value="food">USDA Food List</option>
            <option value="usda">USDA Nutrition Label</option>
            <option value="farmfresh">Farm Fresh (Michigan)</option>
            <option value="nasa">NASA Image Feed</option>
            <option value="serp">Serp API (CORS)</option>
            <option value="gdc">GDC Google Data Commons - Forests</option> -->
            <option value="Count_Person">GDC US State Populations</option>
            <option value="LandCoverFraction_Forest" selected>GDC Land Covered by Forests</option>
            <!-- <option value="datausa">DataUSA State Populations</option>
            <option value="311">See Click Fix Requests</option>
            <option value="open311">See Click Fix Requests (CORS)</option>
            <option value="bsky">BlueSky Model.Earth RSS (CORS)</option>
            <option value="sectors">USEEIO State Sectors</option>
            <option value="flow">USEEIO State Impact Flow</option>
            <option value="Dmatrix">USEEIO D Matrix Commodities</option>
            <option value="civictechindex">Civic Tech Organizations</option>
            <option value="civictechlinks">Civic Tech Links</option>
            <option value="epd">Environmental Product Declarations (EPD)</option> -->
        </select>
        <br>
        <label>
            <input type="checkbox" id="showAllToggle">
            Show All
        </label>
        <canvas id="myChart"></canvas>
        <div id="earthscape1"></div>
        <br>
        
    
        <div id="readmeDiv"></div>
    </div>
    <!-- Needs work:
	<a href="https://chatgpt.com/share/e0e882e9-9a14-4677-abf5-399e509db10d">Source: ChatGPT</a><br><br>
	<a href="/feed/view/#feed=LandCoverFraction_Forest">Our working feed request</a> -->
</body>